<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memento - Memory Slideshow Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="error-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg p-6 max-w-md mx-auto z-10">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>Error</h3>
                <button id="close-error-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p id="error-message" class="mb-4">An error occurred.</p>
            <div class="flex justify-end">
                <button id="error-ok-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                    OK
                </button>
            </div>
        </div>
    </div>

    <div class="hero-bg py-20 mb-8">
        <div class="container mx-auto px-4 text-center">
            <div class="logo-container">
                <img src="/static/images/logo.svg" alt="Memento Logo" class="logo-image mx-auto mb-6">
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 font-display">Memento</h1>
            <p class="text-xl md:text-2xl text-white mb-8">Transform Your Memories into Beautiful Slideshows</p>
            <div class="max-w-3xl mx-auto bg-white/10 backdrop-blur-sm rounded-lg p-6 text-white">
                <h2 class="text-xl font-bold mb-3"><i class="fas fa-cloud-upload-alt mr-2"></i>Free Storage for Your Precious Memories</h2>
                <p class="mb-4">Memento helps you preserve your memories by creating stunning slideshows that you can upload directly to YouTube - giving you <span class="font-bold">unlimited free storage</span> for your precious moments.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fas fa-film text-2xl mb-2"></i>
                        <h3 class="font-bold">GPU-Accelerated</h3>
                        <p class="text-sm">Process large collections quickly with GPU power</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fab fa-youtube text-2xl mb-2"></i>
                        <h3 class="font-bold">YouTube Integration</h3>
                        <p class="text-sm">One-click upload to YouTube for free storage</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fas fa-music text-2xl mb-2"></i>
                        <h3 class="font-bold">Background Music</h3>
                        <p class="text-sm">Add soundtrack to your memories with smart audio mixing</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div id="step-upload" class="container mx-auto px-4 py-8 max-w-4xl">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-6 text-center"><i class="fas fa-upload mr-2"></i>Upload Your Media</h2>
                    
                    <div class="mb-6">
                        <div id="drop-area" class="border-2 border-dashed border-blue-400 rounded-lg p-8 text-center hover:bg-blue-50 transition-colors cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-4"></i>
                            <p class="mb-2">Drag & drop images and videos here</p>
                            <p class="text-sm text-gray-500 mb-4">Supports PNG, JPG, GIF, MP4, MOV, AVI</p>
                            <button id="select-files-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                <i class="fas fa-folder-open mr-2"></i>Select Files
                            </button>
                            <input type="file" id="file-input" multiple accept="image/*,video/*" class="hidden">
                        </div>
                    </div>
                    
                    <!-- Background Audio Section -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-bold mb-2 flex items-center">
                            <i class="fas fa-music mr-2 text-purple-500"></i>
                            Background Audio (Optional)
                        </h3>
                        <p class="text-sm text-gray-600 mb-3">Add music to your slideshow. Audio will automatically fade during videos.</p>
                        <div class="flex items-center">
                            <button id="select-audio-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors mr-3">
                                <i class="fas fa-music mr-2"></i>Select Audio
                            </button>
                            <input type="file" id="audio-input" accept="audio/*" class="hidden">
                            <span id="selected-audio" class="text-sm text-gray-700">No audio selected</span>
                        </div>
                    </div>
                    
                    <!-- Slideshow Settings -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-bold mb-2 flex items-center">
                            <i class="fas fa-sliders-h mr-2 text-green-500"></i>
                            Slideshow Settings
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="duration-slider" class="block text-sm font-medium text-gray-700 mb-1">Image Duration (seconds)</label>
                                <div class="flex items-center">
                                    <input type="range" id="duration-slider" min="1" max="10" value="3" class="w-full mr-2">
                                    <span id="duration-value" class="text-sm font-bold">3s</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">GPU Acceleration</label>
                                <div class="flex items-center">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="force-gpu" class="form-checkbox h-5 w-5 text-blue-600">
                                        <span class="ml-2 text-sm text-gray-700">Force GPU usage</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File List Section with Collapsible UI -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold flex items-center">
                                <i class="fas fa-list mr-2 text-gray-700"></i>
                                Selected Files (<span id="file-count">0</span>)
                            </h3>
                            <button id="toggle-file-list" class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                                <i class="fas fa-chevron-down" id="toggle-icon"></i> Show Files
                            </button>
                        </div>
                        <div id="file-list-container" class="hidden overflow-y-auto max-h-60 border border-gray-200 rounded-lg">
                            <ul id="file-list" class="divide-y divide-gray-200 text-sm"></ul>
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button id="upload-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <i class="fas fa-film mr-2"></i>Create Slideshow
                        </button>
                    </div>
                </div>
            </div>

            <div id="step-processing" class="hidden bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 gradient-text"><i class="fas fa-cogs mr-2"></i>Processing Your Slideshow</h2>
                
                <!-- Main progress bar -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span id="progress-text" class="font-medium">0%</span>
                        <span id="progress-files">0/0 files</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Detailed processing status -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4">
                    <div class="flex items-start">
                        <div class="mr-3 mt-1">
                            <i class="fas fa-spinner fa-spin text-blue-500"></i>
                        </div>
                        <div>
                            <p class="font-bold text-blue-700">Creating your masterpiece...</p>
                            <p id="processing-status" class="mt-1 text-blue-600">Initializing...</p>
                            
                            <!-- Frame processing progress -->
                            <div id="frame-processing-container" class="mt-3 hidden">
                                <p class="text-sm text-blue-600 mb-1">Frame processing: <span id="frame-progress-text">0%</span></p>
                                <div class="w-full bg-blue-200 rounded-full h-2">
                                    <div id="frame-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="frame-details" class="text-xs text-blue-500 mt-1">Processing frame 0/0 at 0 it/s</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Processing details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-700"><i class="fas fa-microchip mr-1 text-purple-500"></i> GPU acceleration: <span id="gpu-status" class="font-medium">Checking...</span></p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-700"><i class="fas fa-clock mr-1 text-green-500"></i> Elapsed time: <span id="elapsed-time" class="font-medium">0s</span></p>
                    </div>
                </div>
                
                <!-- Processing steps -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-2 text-gray-700">Processing Steps</h3>
                    <ul id="processing-steps" class="text-sm space-y-2">
                        <li class="flex items-center">
                            <span class="inline-block w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center mr-2">1</span>
                            <span class="text-blue-700 font-medium">Loading media files</span>
                        </li>
                        <li class="flex items-center text-gray-400">
                            <span class="inline-block w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-2">2</span>
                            <span>Processing images and videos</span>
                        </li>
                        <li class="flex items-center text-gray-400">
                            <span class="inline-block w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-2">3</span>
                            <span>Combining clips</span>
                        </li>
                        <li class="flex items-center text-gray-400">
                            <span class="inline-block w-6 h-6 rounded-full bg-gray-300 text-white text-xs flex items-center justify-center mr-2">4</span>
                            <span>Encoding final video</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div id="step-result" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8 card">
                    <h2 class="text-2xl font-bold mb-4 gradient-text"><i class="fas fa-check-circle mr-2"></i>Slideshow Created!</h2>
                    
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded mb-6">
                        <p class="font-bold">Success!</p>
                        <p>Your slideshow has been created successfully.</p>
                    </div>
                    
                    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-100 p-4 rounded-lg text-center card">
                            <i class="fas fa-clock text-2xl text-blue-500 mb-2"></i>
                            <h3 class="text-lg font-semibold">Processing Time</h3>
                            <p id="stats-time" class="text-2xl font-bold gradient-text">0 sec</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg text-center card">
                            <i class="fas fa-photo-video text-2xl text-blue-500 mb-2"></i>
                            <h3 class="text-lg font-semibold">Media Processed</h3>
                            <p id="stats-files" class="text-2xl font-bold gradient-text">0 files</p>
                            <p id="stats-details" class="text-sm">0 images, 0 videos</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg text-center card">
                            <i class="fas fa-hdd text-2xl text-blue-500 mb-2"></i>
                            <h3 class="text-lg font-semibold">Total Size</h3>
                            <p id="stats-size" class="text-2xl font-bold gradient-text">0 MB</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <a id="download-link" href="#" class="flex-1 btn-primary text-white font-bold py-3 px-4 rounded transition duration-200 text-center flex items-center justify-center" target="_blank">
                            <i class="fas fa-download mr-2"></i> Download Slideshow
                        </a>
                        <button id="youtube-toggle-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded transition duration-200 flex items-center justify-center">
                            <i class="fab fa-youtube mr-2"></i> Upload to YouTube
                        </button>
                    </div>
                </div>
                
                <div id="timestamps-container" class="bg-white rounded-lg shadow-lg p-6 mb-8 card">
                    <h2 class="text-2xl font-bold mb-4 gradient-text"><i class="fas fa-clock mr-2"></i>Media Timeline</h2>
                    <p class="mb-4">Your slideshow contains the following media files:</p>
                    <div id="timestamps-list" class="timestamp-section">
                        <!-- Timestamps will be added here dynamically -->
                    </div>
                </div>
                
                <div id="youtube-options" class="bg-white rounded-lg shadow-lg p-6 hidden card">
                    <h2 class="text-2xl font-bold mb-4 gradient-text"><i class="fab fa-youtube mr-2 text-red-500"></i>YouTube Upload Options</h2>
                    <form id="youtube-form">
                        <div class="mb-4">
                            <label for="youtube-title" class="block text-gray-700 font-bold mb-2">Video Title</label>
                            <input type="text" id="youtube-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter video title">
                        </div>
                        
                        <div class="mb-4">
                            <label for="youtube-description" class="block text-gray-700 font-bold mb-2">Description</label>
                            <textarea id="youtube-description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter video description"></textarea>
                            <p class="text-sm text-gray-500 mt-1">Timestamps will be automatically added to your description.</p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-bold mb-2">Privacy Setting</label>
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="privacy" value="private" class="form-radio" checked>
                                    <span class="ml-2">Private</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="privacy" value="unlisted" class="form-radio">
                                    <span class="ml-2">Unlisted</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="privacy" value="public" class="form-radio">
                                    <span class="ml-2">Public</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button id="youtube-upload-btn" type="submit" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded transition duration-200 flex items-center justify-center">
                                <i class="fab fa-youtube mr-2"></i>Upload to YouTube
                            </button>
                            <button id="youtube-cancel-btn" type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded transition duration-200">
                                Cancel
                            </button>
                        </div>
                    </form>
                    <div id="youtube-upload-status" class="mt-4 p-3 rounded hidden"></div>
                </div>
                
                <div id="youtube-success" class="bg-white rounded-lg shadow-lg p-6 hidden card">
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                        <h2 class="text-2xl font-bold mb-4">Upload Successful!</h2>
                        <p class="mb-6">Your video has been uploaded to YouTube successfully.</p>
                        <a id="youtube-link" href="#" class="text-blue-500 hover:underline text-lg break-all" target="_blank"></a>
                        <div class="mt-8">
                            <button id="youtube-done-btn" class="btn-primary text-white font-bold py-3 px-8 rounded transition duration-200">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center text-gray-500 text-sm mt-8">
                <p>Created with <i class="fas fa-heart text-red-500"></i> for preserving your precious memories</p>
                <p class="mt-2">All processing is done locally on your device with GPU acceleration when available</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // DOM Elements
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const selectFilesBtn = document.getElementById('select-files-btn');
        const audioInput = document.getElementById('audio-input');
        const selectAudioBtn = document.getElementById('select-audio-btn');
        const selectedAudio = document.getElementById('selected-audio');
        const fileList = document.getElementById('file-list');
        const fileListContainer = document.getElementById('file-list-container');
        const toggleFileList = document.getElementById('toggle-file-list');
        const toggleIcon = document.getElementById('toggle-icon');
        const fileCount = document.getElementById('file-count');
        const uploadBtn = document.getElementById('upload-btn');
        const durationSlider = document.getElementById('duration-slider');
        const durationValue = document.getElementById('duration-value');
        const forceGpu = document.getElementById('force-gpu');
        const stepUpload = document.getElementById('step-upload');
        const stepProcessing = document.getElementById('step-processing');
        const stepResult = document.getElementById('step-result');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressFiles = document.getElementById('progress-files');
        const processingStatus = document.getElementById('processing-status');
        const gpuStatus = document.getElementById('gpu-status');
        const downloadLink = document.getElementById('download-link');
        const youtubeTitle = document.getElementById('youtube-title');
        const youtubeDescription = document.getElementById('youtube-description');
        const timestampsList = document.getElementById('timestamps-list');
        const statsTime = document.getElementById('stats-time');
        const statsFiles = document.getElementById('stats-files');
        const statsDetails = document.getElementById('stats-details');
        const statsSize = document.getElementById('stats-size');
        
        // State variables
        let files = [];
        let backgroundAudio = null;
        let currentVideoPath = null;
        let processingStartTime = 0;
        let elapsedTimeInterval = null;
        let currentProcessingStep = 1;
        
        // Initialize Socket.IO
        const socket = io();
        
        // Event Listeners
        selectFilesBtn.addEventListener('click', () => fileInput.click());
        selectAudioBtn.addEventListener('click', () => audioInput.click());
        fileInput.addEventListener('change', e => handleFiles(e.target.files));
        audioInput.addEventListener('change', handleAudioFile);
        dropArea.addEventListener('dragover', handleDragOver);
        dropArea.addEventListener('dragleave', handleDragLeave);
        dropArea.addEventListener('drop', handleDrop);
        toggleFileList.addEventListener('click', toggleFileListView);
        durationSlider.addEventListener('input', updateDurationValue);
        
        // Toggle file list visibility
        function toggleFileListView() {
            fileListContainer.classList.toggle('hidden');
            if (fileListContainer.classList.contains('hidden')) {
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                toggleFileList.innerHTML = '<i class="fas fa-chevron-down" id="toggle-icon"></i> Show Files';
            } else {
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
                toggleFileList.innerHTML = '<i class="fas fa-chevron-up" id="toggle-icon"></i> Hide Files';
            }
        }
        
        // Update duration value display
        function updateDurationValue() {
            durationValue.textContent = `${durationSlider.value}s`;
        }
        
        // Handle audio file selection
        function handleAudioFile(e) {
            const file = e.target.files[0];
            if (file) {
                backgroundAudio = file;
                selectedAudio.textContent = file.name;
                selectedAudio.classList.add('text-purple-600', 'font-medium');
            }
        }
        
        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            dropArea.classList.add('border-blue-600', 'bg-blue-50');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            dropArea.classList.remove('border-blue-600', 'bg-blue-50');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            dropArea.classList.remove('border-blue-600', 'bg-blue-50');
            
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        }
        
        // Error modal functionality
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeErrorModal = document.getElementById('close-error-modal');
        const errorOkBtn = document.getElementById('error-ok-btn');
        
        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }
        
        function hideError() {
            errorModal.classList.add('hidden');
        }
        
        closeErrorModal.addEventListener('click', hideError);
        errorOkBtn.addEventListener('click', hideError);
        
        // File size validation
        const MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1GB per file
        const MAX_TOTAL_SIZE = 8 * 1024 * 1024 * 1024; // 8GB total
        
        function validateFiles(newFiles) {
            let totalSize = files.reduce((sum, file) => sum + file.size, 0);
            
            for (const file of newFiles) {
                if (file.size > MAX_FILE_SIZE) {
                    showError(`File ${file.name} exceeds the maximum file size of 1GB.`);
                    return false;
                }
                
                totalSize += file.size;
                if (totalSize > MAX_TOTAL_SIZE) {
                    showError(`Total file size exceeds the maximum of 8GB. Please select fewer or smaller files.`);
                    return false;
                }
            }
            
            return true;
        }
        
        // Handle file selection
        function handleFiles(newFiles) {
            if (!validateFiles(newFiles)) return;
            
            files = [...files, ...Array.from(newFiles)];
            updateFileList();
            updateUploadButton();
        }
        
        // Update the file list UI
        function updateFileList() {
            fileList.innerHTML = '';
            fileCount.textContent = files.length;
            
            if (files.length > 0 && fileListContainer.classList.contains('hidden')) {
                toggleFileListView(); // Show the file list when files are added
            }
            
            files.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'px-4 py-2 flex justify-between items-center hover:bg-gray-50';
                
                // Determine file type and icon
                let icon = 'fa-file';
                let typeClass = 'text-gray-500';
                
                if (file.type.startsWith('image/')) {
                    icon = 'fa-image';
                    typeClass = 'text-green-500';
                } else if (file.type.startsWith('video/')) {
                    icon = 'fa-video';
                    typeClass = 'text-red-500';
                }
                
                // Format file size
                const fileSize = formatFileSize(file.size);
                
                li.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${icon} ${typeClass} mr-2"></i>
                        <span class="truncate max-w-xs">${file.name}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-xs text-gray-500 mr-3">${fileSize}</span>
                        <button class="text-red-500 hover:text-red-700" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                fileList.appendChild(li);
            });
        }
        
        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }
        
        // Remove a file from the list
        function removeFile(index) {
            files.splice(index, 1);
            updateFileList();
            updateUploadButton();
        }
        
        // Update upload button state
        function updateUploadButton() {
            uploadBtn.disabled = files.length === 0;
        }
        
        // Enhanced upload functionality
        uploadBtn.addEventListener('click', async () => {
            if (files.length === 0) return;
            
            const formData = new FormData();
            files.forEach(file => {
                formData.append('files[]', file);
            });
            
            // Add background audio if selected
            if (backgroundAudio) {
                formData.append('background_audio', backgroundAudio);
            }
            
            // Add duration setting
            formData.append('duration', durationSlider.value);
            
            // Add force GPU setting
            formData.append('force_gpu', forceGpu.checked);

            // Switch to processing view
            stepUpload.classList.add('hidden');
            stepProcessing.classList.remove('hidden');
            
            // Reset progress indicators
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            progressFiles.textContent = `0/${files.length} files`;
            processingStatus.textContent = 'Starting processing...';
            gpuStatus.textContent = 'Checking...';

            processingStartTime = Date.now();
            updateElapsedTime();
            elapsedTimeInterval = setInterval(updateElapsedTime, 1000);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Store video path for potential YouTube upload
                    currentVideoPath = data.video_path;
                    downloadLink.href = `/download/${data.video_path}`;
                    
                    // Pre-fill YouTube form
                    youtubeTitle.value = `My Memories - ${new Date().toLocaleDateString()}`;
                    youtubeDescription.value = `Slideshow created on ${new Date().toLocaleDateString()} with ${data.stats.total_files} media files.`;
                    
                    // Update timestamps list
                    if (data.stats.timestamps) {
                        updateTimestampsList(data.stats.timestamps);
                    }
                    
                    // If no socket.io update happened, manually update stats
                    if (!stepResult.classList.contains('visible')) {
                        statsTime.textContent = `${data.stats.processing_time} sec`;
                        statsFiles.textContent = `${data.stats.total_files} files`;
                        statsDetails.textContent = `${data.stats.image_count} images, ${data.stats.video_count} videos`;
                        statsSize.textContent = `${data.stats.total_size_mb} MB`;
                        gpuStatus.textContent = data.stats.gpu_used ? 'Yes' : 'No';
                        
                        // Show celebration animation
                        createConfetti();
                        
                        // Switch to result view
                        stepProcessing.classList.add('hidden');
                        stepResult.classList.remove('hidden');
                    }
                    
                    // Clear the files array after successful processing
                    files = [];
                    backgroundAudio = null;
                    selectedAudio.textContent = 'No audio selected';
                    selectedAudio.classList.remove('text-purple-600', 'font-medium');
                    updateFileList();
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            } catch (error) {
                showError(`Error creating slideshow: ${error.message}`);
                // Go back to upload view
                stepProcessing.classList.add('hidden');
                stepUpload.classList.remove('hidden');
            }
        });
        
        // Socket.IO event handlers
        socket.on('processing_progress', data => {
            progressBar.style.width = `${data.progress}%`;
            progressText.textContent = `${data.progress}%`;
            progressFiles.textContent = `${data.processed}/${data.total} files`;
            
            // Update processing status with more details
            if (data.current_file.includes('frame_index')) {
                // This is a frame processing update
                const frameProcessingContainer = document.getElementById('frame-processing-container');
                const frameProgressBar = document.getElementById('frame-progress-bar');
                const frameProgressText = document.getElementById('frame-progress-text');
                const frameDetails = document.getElementById('frame-details');
                
                // Parse the frame processing data
                const match = data.current_file.match(/frame_index:\s*(\d+)%\|([^\[]+)\[([^\]]+)\]\s*([^,]+),\s*([^\s]+)/);
                
                if (match) {
                    const percent = match[1];
                    const progressBar = match[2];
                    const framesInfo = match[3];
                    const speed = match[5];
                    
                    // Show the frame processing container
                    frameProcessingContainer.classList.remove('hidden');
                    
                    // Update the frame progress
                    frameProgressBar.style.width = `${percent}%`;
                    frameProgressText.textContent = `${percent}%`;
                    
                    // Extract frame numbers
                    const frameMatch = framesInfo.match(/(\d+)\/(\d+)/);
                    if (frameMatch) {
                        const currentFrame = frameMatch[1];
                        const totalFrames = frameMatch[2];
                        frameDetails.textContent = `Processing frame ${currentFrame}/${totalFrames} at ${speed}`;
                    }
                    
                    // Update processing step to encoding (step 3)
                    updateProcessingStep(3);
                }
                
                processingStatus.textContent = `Encoding video...`;
            } else {
                // Regular file processing update
                processingStatus.textContent = `Processing: ${data.current_file}`;
                
                // Update processing step based on progress
                if (data.progress < 10) {
                    updateProcessingStep(0);
                } else if (data.progress < 80) {
                    updateProcessingStep(1);
                } else if (data.progress < 90) {
                    updateProcessingStep(2);
                } else {
                    updateProcessingStep(3);
                }
            }
        });

        socket.on('processing_complete', data => {
            // Clear the elapsed time interval
            if (elapsedTimeInterval) {
                clearInterval(elapsedTimeInterval);
            }
            
            // Update all steps to completed
            updateProcessingStep(4);
            
            // Update stats
            statsTime.textContent = `${data.processing_time} sec`;
            statsFiles.textContent = `${data.total_files} files`;
            statsDetails.textContent = `${data.image_count} images, ${data.video_count} videos`;
            statsSize.textContent = `${data.total_size_mb} MB`;
            gpuStatus.textContent = data.gpu_used ? 'Yes' : 'No';
            
            // Update timestamps
            updateTimestampsList(data.timestamps);
            
            // Show celebration animation
            createConfetti();
            
            // Switch to result view
            stepProcessing.classList.add('hidden');
            stepResult.classList.remove('hidden');
        });
        
        // Update elapsed time
        function updateElapsedTime() {
            const elapsedSeconds = Math.floor((Date.now() - processingStartTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('elapsed-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Update processing step
        function updateProcessingStep(step) {
            const steps = document.querySelectorAll('#processing-steps li');
            currentProcessingStep = step;
            
            steps.forEach((stepEl, index) => {
                if (index < step) {
                    // Completed steps
                    stepEl.classList.remove('text-gray-400');
                    stepEl.classList.add('text-green-700');
                    stepEl.querySelector('span:first-child').classList.remove('bg-gray-300', 'bg-blue-500');
                    stepEl.querySelector('span:first-child').classList.add('bg-green-500');
                    stepEl.querySelector('span:last-child').classList.add('font-medium');
                } else if (index === step) {
                    // Current step
                    stepEl.classList.remove('text-gray-400');
                    stepEl.classList.add('text-blue-700');
                    stepEl.querySelector('span:first-child').classList.remove('bg-gray-300');
                    stepEl.querySelector('span:first-child').classList.add('bg-blue-500');
                    stepEl.querySelector('span:last-child').classList.add('font-medium');
                } else {
                    // Future steps
                    stepEl.classList.add('text-gray-400');
                    stepEl.classList.remove('text-blue-700', 'text-green-700');
                    stepEl.querySelector('span:first-child').classList.add('bg-gray-300');
                    stepEl.querySelector('span:first-child').classList.remove('bg-blue-500', 'bg-green-500');
                    stepEl.querySelector('span:last-child').classList.remove('font-medium');
                }
            });
        }
        
        // Update timestamps list
        function updateTimestampsList(timestamps) {
            if (!timestamps || !timestampsList) return;
            
            timestampsList.innerHTML = '';
            
            timestamps.forEach(ts => {
                const minutes = Math.floor(ts.time / 60);
                const seconds = Math.floor(ts.time % 60);
                const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const li = document.createElement('li');
                li.className = 'mb-1 flex items-start';
                
                // Add icon based on type
                const icon = ts.type === 'video' ? 'fa-video text-red-500' : 'fa-image text-blue-500';
                
                li.innerHTML = `
                    <span class="inline-block w-12 font-mono text-gray-600">${timeFormatted}</span>
                    <i class="fas ${icon} mr-2 mt-1"></i>
                    <span class="text-gray-800 truncate">${ts.name}</span>
                `;
                
                timestampsList.appendChild(li);
            });
        }
        
        // YouTube upload functionality
        document.addEventListener('DOMContentLoaded', function() {
            const youtubeForm = document.getElementById('youtube-form');
            const youtubeTitle = document.getElementById('youtube-title');
            const youtubeDescription = document.getElementById('youtube-description');
            const youtubeUploadBtn = document.getElementById('youtube-upload-btn');
            const uploadStatus = document.getElementById('youtube-upload-status');
            const timestampsList = document.getElementById('timestamps-list');
            
            // Toggle YouTube options
            const youtubeToggleBtn = document.getElementById('youtube-toggle-btn');
            const youtubeOptions = document.getElementById('youtube-options');
            const youtubeCancelBtn = document.getElementById('youtube-cancel-btn');
            
            if (youtubeToggleBtn) {
                youtubeToggleBtn.addEventListener('click', function() {
                    youtubeOptions.classList.toggle('hidden');
                    console.log('YouTube options toggled');
                });
            }
            
            if (youtubeCancelBtn) {
                youtubeCancelBtn.addEventListener('click', function() {
                    youtubeOptions.classList.add('hidden');
                    console.log('YouTube options canceled');
                });
            }
            
            // Handle form submission
            if (youtubeForm) {
                console.log('YouTube form found, adding event listener');
                
                youtubeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('YouTube form submitted');
                    
                    if (!currentVideoPath) {
                        showError('No video available to upload');
                        return;
                    }
                    
                    // Get form values
                    const title = youtubeTitle.value || 'My Memories Slideshow';
                    const description = youtubeDescription.value || 'Created with Memento Slideshow Creator';
                    const privacy = document.querySelector('input[name="privacy"]:checked')?.value || 'private';
                    
                    console.log('Upload details:', { title, privacy, videoPath: currentVideoPath });
                    
                    // Update UI
                    youtubeUploadBtn.disabled = true;
                    youtubeUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
                    uploadStatus.textContent = 'Connecting to YouTube...';
                    uploadStatus.classList.remove('hidden');
                    
                    // Create request data
                    const requestData = {
                        video_path: currentVideoPath,
                        title: title,
                        description: description,
                        privacy: privacy,
                        timestamps: timestampsList && timestampsList.dataset.timestamps ? JSON.parse(timestampsList.dataset.timestamps) : []
                    };
                    
                    console.log('Sending request with data:', requestData);
                    
                    // Send the request
                    fetch('/upload-to-youtube', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        console.log('Response received:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Upload success data:', data);
                        if (data.success) {
                            uploadStatus.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>Upload successful! <a href="${data.youtube_url}" target="_blank" class="text-blue-500 hover:underline">View on YouTube</a>`;
                            createConfetti();
                        } else {
                            throw new Error(data.error || 'Upload failed');
                        }
                    })
                    .catch(error => {
                        console.error('Upload error:', error);
                        uploadStatus.innerHTML = `<i class="fas fa-exclamation-circle text-red-500 mr-2"></i>${error.message}`;
                    })
                    .finally(() => {
                        youtubeUploadBtn.disabled = false;
                        youtubeUploadBtn.innerHTML = '<i class="fab fa-youtube mr-2"></i>Upload to YouTube';
                    });
                });
            } else {
                console.error('YouTube form not found!');
            }
        });
    </script>
    
    <!-- Confetti animation -->
    <script>
        function createConfetti() {
            const confettiCount = 200;
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.opacity = Math.random();
                confetti.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
                
                document.body.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }
    </script>
</body>
</html>
